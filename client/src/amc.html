<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Aronia MUD</title>
<link rel="stylesheet" href="lib/xterm.css" />
<script src="lib/bin/xterm.js"></script>
<script src="lib/bin/addon-fit.js"></script>
<style>
* {margin:0; padding:0; box-sizing: border-box;}

html {
    width: 100dvw;
    height: 100dvh;
}

body {
    width: 100%;
    height: 100%;
    background-color: black;
    font-size: 0; /* Prevents bugs when window is zoomed in by some 500%. */
    overflow: hidden;
    padding-left: 0.5rem;
}

#terminal {
    width: 100%;
    height: 100%;
}
</style>
</head>

<body>
<div id="terminal"></div>
<script>
function rawStringToBuffer( str ) {
    var idx, len = str.length, arr = new Array( len );
    for ( idx = 0 ; idx < len ; ++idx ) {
        arr[ idx ] = str.charCodeAt(idx) & 0xFF;
    }

    return new Uint8Array( arr ).buffer;
}

var ws = null;
var term = new Terminal();
var term_fit = new FitAddon.FitAddon();

term.loadAddon(term_fit);

term.open(document.getElementById('terminal'));

term_fit.fit();
window.addEventListener('resize', function () {term_fit.fit();});

term.onKey(
    e => {
        if (e.domEvent.key == "Backspace") {
            ws.send(rawStringToBuffer("\b"));
            term.write("\b \b");
        }
        else if (e.key == '\r') {
            term.write('\n\r');
            ws.send(rawStringToBuffer("\n"));
        }
        else {
            ws.send(rawStringToBuffer(e.key));
            term.write(e.key);
        }
    }
);

function connect() {
    ws = new WebSocket("ws://aronia.ee:4004");

    ws.onmessage = function (evt) {
        var received_msg = evt.data;
        var reader = new FileReader();

        reader.onload = function() {
            term.write(reader.result);
        }

        reader.readAsText(evt.data);
    };

    ws.onclose = function() {
        term.write("\n\r#Disconnected.");

        setTimeout(
            function() {
                term.write("\n\r#Reconnecting...\n\r");
                connect();
            }, 1000
        );
    };

    ws.onerror = function(err) {
        term.write("\n\r#Error: "+err.message+"\n\r");
        ws.close();
    };
}

connect();

</script>
</body>

</html>
